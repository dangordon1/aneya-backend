-- Migration: Create {{ form_name_title }} Forms Table
-- Description: {{ description }}
-- Created: {{ created_date }}
-- Generated by: form_converter tool

-- ==============================================================================
-- CREATE {{ form_name_upper }}_FORMS TABLE
-- ==============================================================================

CREATE TABLE IF NOT EXISTS {{ form_name }}_forms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  appointment_id UUID REFERENCES appointments(id) ON DELETE SET NULL,

  -- Form metadata
  form_type TEXT CHECK (form_type IN ('pre_consultation', 'during_consultation')),
  status TEXT CHECK (status IN ('draft', 'partial', 'completed')) DEFAULT 'draft',
  filled_by UUID REFERENCES auth.users(id), -- NULL if patient, doctor_id if doctor-filled

  -- Reference to shared health records (prevents duplication)
  vitals_record_id UUID REFERENCES patient_vitals(id),

  -- {{ form_name_title }}-specific fields (JSONB for flexibility - no schema updates needed)
  {{ form_name }}_data JSONB NOT NULL DEFAULT '{}',

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id)
);

-- Create indexes for common queries
CREATE INDEX idx_{{ form_name }}_forms_patient ON {{ form_name }}_forms(patient_id);
CREATE INDEX idx_{{ form_name }}_forms_appointment ON {{ form_name }}_forms(appointment_id);
CREATE INDEX idx_{{ form_name }}_forms_status ON {{ form_name }}_forms(status);
CREATE INDEX idx_{{ form_name }}_forms_form_type ON {{ form_name }}_forms(form_type);

-- JSONB GIN index for querying nested fields efficiently
CREATE INDEX idx_{{ form_name }}_data ON {{ form_name }}_forms USING gin({{ form_name }}_data);

-- Add column comments for documentation
COMMENT ON TABLE {{ form_name }}_forms IS '{{ description }}';
COMMENT ON COLUMN {{ form_name }}_forms.form_type IS 'When form is filled: pre_consultation (patient) or during_consultation (doctor)';
COMMENT ON COLUMN {{ form_name }}_forms.status IS 'Form completion status: draft, partial, completed';
COMMENT ON COLUMN {{ form_name }}_forms.filled_by IS 'NULL if filled by patient, doctor user_id if filled by doctor';
COMMENT ON COLUMN {{ form_name }}_forms.vitals_record_id IS 'Reference to shared patient_vitals table (prevents duplication)';
COMMENT ON COLUMN {{ form_name }}_forms.{{ form_name }}_data IS 'JSONB containing all {{ form_name }}-specific fields (flexible schema)';

-- ==============================================================================
-- {{ form_name_upper }}_DATA JSONB STRUCTURE (DOCUMENTED)
-- ==============================================================================
-- {
{% for section in sections %}
--   "{{ section.name }}": {
{% for field in section.fields[:5] %}
--     "{{ field.name }}": {{ field.example_value }},  // {{ field.description }}
{% endfor %}
{% if section.fields|length > 5 %}
--     // ... {{ section.fields|length - 5 }} more fields
{% endif %}
--   },
{% endfor %}
-- }
-- ==============================================================================

-- ==============================================================================
-- CREATE TRIGGER FOR UPDATED_AT
-- ==============================================================================

CREATE OR REPLACE FUNCTION update_{{ form_name }}_forms_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_{{ form_name }}_forms_timestamp
  BEFORE UPDATE ON {{ form_name }}_forms
  FOR EACH ROW
  EXECUTE FUNCTION update_{{ form_name }}_forms_timestamp();

-- ==============================================================================
-- MIGRATION NOTES
-- ==============================================================================
-- This table implements the JSONB-based flexible schema approach:
-- - No schema updates needed to add new fields
-- - GIN index enables fast JSONB queries
-- - References shared health records (vitals) to prevent duplication
-- - Field registration in field_definitions table happens at application layer
--
-- Benefits:
-- 1. Rapid iteration - add fields without migrations
-- 2. Type safety - validated by TypeScript interfaces
-- 3. Performance - GIN indexes provide fast queries
-- 4. No duplication - shared data stored in generic tables
--
-- Next steps:
-- - Update form_schemas.py with {{ form_name_upper }}_FORM_SCHEMA
-- - Create TypeScript interfaces ({{ form_name_title }}FormData)
-- - Build {{ form_name_title }}PreConsultationForm component
-- - Implement use{{ form_name_title }}Forms hook
-- - Add field registration logic
-- ==============================================================================
